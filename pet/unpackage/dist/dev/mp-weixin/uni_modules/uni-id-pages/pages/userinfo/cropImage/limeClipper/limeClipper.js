"use strict";var o=require("../../../../../../common/vendor.js"),f=require("./utils.js");const d={},M={name:"l-clipper",props:{value:{type:Boolean,default:!0},type:{type:String,default:"2d"},customStyle:{type:String},canvasId:{type:String,default:"l-clipper"},zIndex:{type:Number,default:99},imageUrl:{type:String},fileType:{type:String,default:"png"},quality:{type:Number,default:1},width:{type:Number,default:400},height:{type:Number,default:400},minWidth:{type:Number,default:200},maxWidth:{type:Number,default:600},minHeight:{type:Number,default:200},maxHeight:{type:Number,default:600},isLockWidth:{type:Boolean,default:!1},isLockHeight:{type:Boolean,default:!1},isLockRatio:{type:Boolean,default:!0},scaleRatio:{type:Number,default:1},minRatio:{type:Number,default:.5},maxRatio:{type:Number,default:2},isDisableScale:{type:Boolean,default:!1},isDisableRotate:{type:Boolean,default:!1},isLimitMove:{type:Boolean,default:!1},isShowPhotoBtn:{type:Boolean,default:!0},isShowRotateBtn:{type:Boolean,default:!0},isShowConfirmBtn:{type:Boolean,default:!0},isShowCancelBtn:{type:Boolean,default:!0},rotateAngle:{type:Number,default:90},source:{type:Object,default:()=>({album:"\u4ECE\u76F8\u518C\u4E2D\u9009\u62E9",camera:"\u62CD\u7167",message:"\u4ECE\u5FAE\u4FE1\u4E2D\u9009\u62E9"})}},data(){return{canvasWidth:0,canvasHeight:0,clipX:0,clipY:0,clipWidth:0,clipHeight:0,animation:!1,imageWidth:0,imageHeight:0,imageTop:0,imageLeft:0,scale:1,angle:0,image:this.imageUrl,sysinfo:{},throttleTimer:null,throttleFlag:!0,timeClipCenter:null,flagClipTouch:!1,flagEndTouch:!1,clipStart:{},animationTimer:null,touchRelative:[{x:0,y:0}],hypotenuseLength:0,ctx:null}},computed:{clipStyle(){const{clipWidth:t,clipHeight:e,clipY:i,clipX:l,animation:s}=this;return`
			width: ${t}px;
			height:${e}px;
			transition-property: ${s?"":"background"};
			left: ${l}px;
			top: ${i}px
			`},imageStyle(){const{imageWidth:t,imageHeight:e,imageLeft:i,imageTop:l,animation:s,scale:a,angle:h}=this;return`
				width: ${t?t+"px":"auto"};
				height: ${e?e+"px":"auto"};
				transform: translate3d(${i-t/2}px, ${l-e/2}px, 0) scale(${a}) rotate(${h}deg);
				transition-duration: ${s?.35:0}s
			`},clipSize(){const{clipWidth:t,clipHeight:e}=this;return{clipWidth:t,clipHeight:e}},clipPoint(){const{clipY:t,clipX:e}=this;return{clipY:t,clipX:e}}},watch:{value(t){if(!t)this.animation=0,this.angle=0;else if(this.imageUrl){const{imageWidth:e,imageHeight:i,imageLeft:l,imageTop:s,scale:a,clipX:h,clipY:n,clipWidth:g,clipHeight:m,path:c}=(d==null?void 0:d[this.imageUrl])||{};c!=this.image?this.image=this.imageUrl:this.setDiffData({imageWidth:e,imageHeight:i,imageLeft:l,imageTop:s,scale:a,clipX:h,clipY:n,clipWidth:g,clipHeight:m})}},imageUrl(t){this.image=t},image:{handler:async function(t){this.getImageInfo(t)}},clipSize({widthVal:t,heightVal:e}){let{minWidth:i,minHeight:l}=this;i=i/2,l=l/2,t<i&&this.setDiffData({clipWidth:i}),e<l&&this.setDiffData({clipHeight:l}),this.calcClipSize()},angle(t){this.animation=!0,this.moveStop();const{isLimitMove:e}=this;e&&t%90&&this.setDiffData({angle:Math.round(t/90)*90}),this.imgMarginDetectionScale()},animation(t){if(clearTimeout(this.animationTimer),t){let e=setTimeout(()=>{this.setDiffData({animation:!1})},260);this.setDiffData({animationTimer:e}),this.animationTimer=e}},isLimitMove(t){t&&(this.angle%90&&this.setDiffData({angle:Math.round(this.angle/90)*90}),this.imgMarginDetectionScale())},clipPoint(){this.cutDetectionPosition()},width(t,e){t!==e&&this.setDiffData({clipWidth:t/2})},height(t,e){t!==e&&this.setDiffData({clipHeight:t/2})}},mounted(){const t=o.index.getSystemInfoSync();this.sysinfo=t,this.setClipInfo(),this.image&&this.getImageInfo(this.image),this.setClipCenter(),this.calcClipSize(),this.cutDetectionPosition()},methods:{setDiffData(t){Object.keys(t).forEach(e=>{this[e]!==t[e]&&(this[e]=t[e])})},getImageInfo(t){!t||(this.value&&o.index.showLoading({title:"\u8BF7\u7A0D\u5019...",mask:!0}),o.index.getImageInfo({src:t,success:e=>{this.imgComputeSize(e.width,e.height),this.image=e.path,this.isLimitMove&&(this.imgMarginDetectionScale(),this.$emit("ready",e));const{imageWidth:i,imageHeight:l,imageLeft:s,imageTop:a,scale:h,clipX:n,clipY:g,clipWidth:m,clipHeight:c}=this;d[t]=Object.assign(e,{imageWidth:i,imageHeight:l,imageLeft:s,imageTop:a,scale:h,clipX:n,clipY:g,clipWidth:m,clipHeight:c})},fail:e=>{this.imgComputeSize(),this.isLimitMove&&this.imgMarginDetectionScale()}}))},setClipInfo(){const{width:t,height:e,sysinfo:i,canvasId:l}=this,s=t/2,a=e/2,h=(i.windowHeight-a)/2,n=(i.windowWidth-s)/2,g=i.windowWidth/2,m=i.windowHeight/2;this.ctx=o.index.createCanvasContext(l,this),this.clipWidth=s,this.clipHeight=a,this.clipX=n,this.clipY=h,this.canvasHeight=a,this.canvasWidth=s,this.imageLeft=g,this.imageTop=m},setClipCenter(){const{sysInfo:t,clipHeight:e,clipWidth:i,imageTop:l,imageLeft:s}=this;let a=t||o.index.getSystemInfoSync(),h=(a.windowHeight-e)*.5,n=(a.windowWidth-i)*.5;this.imageTop=l-this.clipY+h,this.imageLeft=s-this.clipX+n,this.clipY=h,this.clipX=n},calcClipSize(){const{clipHeight:t,clipWidth:e,sysinfo:i,clipX:l,clipY:s}=this;e>i.windowWidth?this.setDiffData({clipWidth:i.windowWidth}):e+l>i.windowWidth&&this.setDiffData({clipX:i.windowWidth-l}),t>i.windowHeight?this.setDiffData({clipHeight:i.windowHeight}):t+s>i.windowHeight&&(this.clipY=i.windowHeight-s,this.setDiffData({clipY:i.windowHeight-s}))},cutDetectionPosition(){const{clipX:t,clipY:e,sysinfo:i,clipHeight:l,clipWidth:s}=this;let a=()=>{e<0&&this.setDiffData({clipY:0}),e>i.windowHeight-l&&this.setDiffData({clipY:i.windowHeight-l})},h=()=>{t<0&&this.setDiffData({clipX:0}),t>i.windowWidth-s&&this.setDiffData({clipX:i.windowWidth-s})};if(e===null&&t===null){let n=(i.windowHeight-l)*.5,g=(i.windowWidth-s)*.5;this.setDiffData({clipX:g,clipY:n})}else e!==null&&t!==null?(a(),h()):e!==null&&t===null?(a(),this.setDiffData({clipX:(i.windowWidth-s)/2})):e===null&&t!==null&&(h(),this.setDiffData({clipY:(i.windowHeight-l)/2}))},imgComputeSize(t,e){const{imageWidth:i,imageHeight:l}=f.calcImageSize(t,e,this);this.imageWidth=i,this.imageHeight=l},imgMarginDetectionScale(t){if(!this.isLimitMove)return;const e=f.calcImageScale(this,t);this.imgMarginDetectionPosition(e)},imgMarginDetectionPosition(t){if(!this.isLimitMove)return;const{scale:e,left:i,top:l}=f.calcImageOffset(this,t);this.setDiffData({imageLeft:i,imageTop:l,scale:e})},throttle(){this.setDiffData({throttleFlag:!0})},moveDuring(){clearTimeout(this.timeClipCenter)},moveStop(){clearTimeout(this.timeClipCenter);const t=setTimeout(()=>{this.animation||this.setDiffData({animation:!0}),this.setClipCenter()},800);this.setDiffData({timeClipCenter:t})},clipTouchStart(t){if(!this.image){o.index.showToast({title:"\u8BF7\u9009\u62E9\u56FE\u7247",icon:"none"});return}const e=t.touches[0].clientX,i=t.touches[0].clientY,{clipX:l,clipY:s,clipWidth:a,clipHeight:h}=this,n=f.determineDirection(l,s,a,h,e,i);this.moveDuring(),n&&(this.clipStart={width:a,height:h,x:e,y:i,clipY:s,clipX:l,corner:n},this.flagClipTouch=!0,this.flagEndTouch=!0)},clipTouchMove(t){if(!this.image){o.index.showToast({title:"\u8BF7\u9009\u62E9\u56FE\u7247",icon:"none"});return}if(t.touches.length!==1)return;const{flagClipTouch:e,throttleFlag:i}=this;if(e&&i){const{isLockRatio:l,isLockHeight:s,isLockWidth:a}=this;if(l&&(a||s))return;this.setDiffData({throttleFlag:!1}),this.throttle();const h=f.clipTouchMoveOfCalculate(this,t);if(h){const{width:n,height:g,clipX:m,clipY:c}=h;!a&&!s?this.setDiffData({clipWidth:n,clipHeight:g,clipX:m,clipY:c}):a?s||this.setDiffData({clipHeight:g,clipY:c}):this.setDiffData({clipWidth:n,clipX:m}),this.imgMarginDetectionScale()}}},clipTouchEnd(){this.moveStop(),this.flagClipTouch=!1},imageTouchStart(t){this.flagEndTouch=!1;const{imageLeft:e,imageTop:i}=this,l=t.touches[0].clientX,s=t.touches[0].clientY;let a=[];if(t.touches.length===1)a[0]={x:l-e,y:s-i},this.touchRelative=a;else{const h=t.touches[1].clientX,n=t.touches[1].clientY;let g=Math.abs(l-h),m=Math.abs(s-n);const c=f.calcPythagoreanTheorem(g,m);a=[{x:l-e,y:s-i},{x:h-e,y:n-i}],this.touchRelative=a,this.hypotenuseLength=c}},imageTouchMove(t){const{flagEndTouch:e,throttleFlag:i}=this;if(e||!i)return;const l=t.touches[0].clientX,s=t.touches[0].clientY;if(this.setDiffData({throttleFlag:!1}),this.throttle(),this.moveDuring(),t.touches.length===1){const{left:a,top:h}=f.imageTouchMoveOfCalcOffset(this,l,s);this.setDiffData({imageLeft:a,imageTop:h}),this.imgMarginDetectionPosition()}else{const a=t.touches[1].clientX,h=t.touches[1].clientY;let n=Math.abs(l-a),g=Math.abs(s-h),m=f.calcPythagoreanTheorem(n,g),c=this.scale*(m/this.hypotenuseLength);this.isDisableScale?c=1:(c=c<=this.minRatio?this.minRatio:c,c=c>=this.maxRatio?this.maxRatio:c,this.$emit("change",{width:this.imageWidth*c,height:this.imageHeight*c})),this.imgMarginDetectionScale(c),this.hypotenuseLength=Math.sqrt(Math.pow(n,2)+Math.pow(g,2)),this.scale=c}},imageTouchEnd(){this.setDiffData({flagEndTouch:!0}),this.moveStop()},uploadImage(){const t=Object.entries(this.source),e=["original","compressed"],i=({tempFilePaths:s,tempFiles:a})=>{this.image=s?s[0]:a[0].path},l=s=>{s!=="message"&&o.index.chooseImage({count:1,sizeType:e,sourceType:[s],success:i}),s=="message"&&wx.chooseMessageFile({count:1,type:"image",success:i})};t.length>1?o.index.showActionSheet({itemList:t.map(s=>s[1]),success:({tapIndex:s})=>{l(t[s][0])}}):l(t[0][0])},imageReset(){const t=this.sysinfo||o.index.getSystemInfoSync();this.scale=1,this.angle=0,this.imageTop=t.windowHeight/2,this.imageLeft=t.windowWidth/2},imageLoad(t){this.imageReset(),o.index.hideLoading(),this.$emit("ready",t.detail)},rotate(t){if(this.isDisableRotate)return;if(!this.image){o.index.showToast({title:"\u8BF7\u9009\u62E9\u56FE\u7247",icon:"none"});return}const{rotateAngle:e}=this,i=this.angle;t.currentTarget.dataset.type==="along"?this.angle=i+e:this.angle=i-e,this.$emit("rotate",this.angle)},confirm(){if(!this.image){o.index.showToast({title:"\u8BF7\u9009\u62E9\u56FE\u7247",icon:"none"});return}o.index.showLoading({title:"\u52A0\u8F7D\u4E2D"});const{canvasHeight:t,canvasWidth:e,clipHeight:i,clipWidth:l,ctx:s,scale:a,imageLeft:h,imageTop:n,clipX:g,clipY:m,angle:c,scaleRatio:r,image:v,quality:H,fileType:W,type:b,canvasId:L}=this,D=()=>{const y=this.imageWidth*a*r,T=this.imageHeight*a*r,x=h-g,C=n-m;s.translate(x*r,C*r),s.rotate(c*Math.PI/180),s.drawImage(v,-y/2,-T/2,y,T),s.draw(!1,()=>{const p=l*r,w=i*r;let I={x:0,y:0,width:p,height:w,destWidth:p,destHeight:w,canvasId:L,fileType:W,quality:H,success:u=>{S.url=u.tempFilePath,o.index.hideLoading(),this.$emit("success",S),this.$emit("input",!1)},fail:u=>{console.error("error",u),this.$emit("fail",u),this.$emit("input",!1)}},S={url:"",width:p,height:w};o.index.canvasToTempFilePath(I,this)})};e!==l||t!==i?(this.canvasWidth=l,this.canvasHeight=i,s.draw(),this.$nextTick(()=>{setTimeout(()=>{D()},100)})):D()},cancel(){this.$emit("cancel",!1),this.$emit("input",!1)}}};function Y(t,e,i,l,s,a){return o.e({a:o.f([0,0,0,0],(h,n,g)=>({a:n})),b:o.s(a.clipStyle),c:o.o((...h)=>a.clipTouchStart&&a.clipTouchStart(...h)),d:o.o((...h)=>a.clipTouchMove&&a.clipTouchMove(...h)),e:o.o((...h)=>a.clipTouchEnd&&a.clipTouchEnd(...h)),f:s.image},s.image?{g:o.o((...h)=>a.imageLoad&&a.imageLoad(...h)),h:o.o((...h)=>a.imageLoad&&a.imageLoad(...h)),i:o.o((...h)=>a.imageTouchStart&&a.imageTouchStart(...h)),j:o.o((...h)=>a.imageTouchMove&&a.imageTouchMove(...h)),k:o.o((...h)=>a.imageTouchEnd&&a.imageTouchEnd(...h)),l:s.image,m:s.imageWidth=="auto"?"widthFix":"",n:o.s(a.imageStyle)}:{},{o:i.canvasId,p:o.s("width: "+s.canvasWidth*i.scaleRatio+"px; height:"+s.canvasHeight*i.scaleRatio+"px;"),q:i.isShowCancelBtn},i.isShowCancelBtn?o.e({r:t.$slots.cancel},t.$slots.cancel?{}:{},{s:o.o((...h)=>a.cancel&&a.cancel(...h))}):{},{t:i.isShowPhotoBtn},i.isShowPhotoBtn?o.e({v:t.$slots.photo},t.$slots.photo?{}:{},{w:o.o((...h)=>a.uploadImage&&a.uploadImage(...h))}):{},{x:i.isShowRotateBtn},i.isShowRotateBtn?o.e({y:t.$slots.rotate},t.$slots.rotate?{}:{},{z:o.o((...h)=>a.rotate&&a.rotate(...h))}):{},{A:i.isShowConfirmBtn},i.isShowConfirmBtn?o.e({B:t.$slots.confirm},t.$slots.confirm?{}:{},{C:o.o((...h)=>a.confirm&&a.confirm(...h))}):{},{D:i.value?1:"",E:o.s("z-index: "+i.zIndex+";"+i.customStyle)})}var X=o._export_sfc(M,[["render",Y],["__scopeId","data-v-d7d092c6"],["__file","C:/Users/yzc/Desktop/pet/uni_modules/uni-id-pages/pages/userinfo/cropImage/limeClipper/limeClipper.vue"]]);wx.createComponent(X);
