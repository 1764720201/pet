"use strict";var E=Object.defineProperty,N=Object.defineProperties;var O=Object.getOwnPropertyDescriptors;var S=Object.getOwnPropertySymbols;var z=Object.prototype.hasOwnProperty,H=Object.prototype.propertyIsEnumerable;var W=(d,t,a)=>t in d?E(d,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):d[t]=a,u=(d,t)=>{for(var a in t||(t={}))z.call(t,a)&&W(d,a,t[a]);if(S)for(var a of S(t))H.call(t,a)&&W(d,a,t[a]);return d},A=(d,t)=>N(d,O(t));var P=(d,t)=>{var a={};for(var e in d)z.call(d,e)&&t.indexOf(e)<0&&(a[e]=d[e]);if(d!=null&&S)for(var e of S(d))t.indexOf(e)<0&&H.call(d,e)&&(a[e]=d[e]);return a};var C=require("../../../common/vendor.js"),X=require("./methods/text.js"),G=require("./methods/line.js"),J=require("./methods/rect.js"),K=require("./methods/arc.js"),q=require("./methods/image.js"),Y=require("./methods/triangle.js"),Z=require("./methods/qrcode.js"),tt=require("./methods/canvas.js"),$=require("./utils/common.js");class et{constructor(t){const{width:a=375.0001,height:e=0,canvasId:n=null,_this:l=null,background:r={},type:c="default",unit:o="px",drawDelayTime:h=200,exportImageDelayTime:s=200,drawTipsText:i="\u7ED8\u5236\u4E2D...",exportImageTips:m="\u5BFC\u51FA\u56FE\u7247\u4E2D...",fontStyle:w={},exportImageStyle:f={}}=t;this.background=u({type:"color",w:a,h:e,color:"#ffffff"},r),this.canvasId=n,this._this=l,this.type=c,this.is2d=this.type==="2d",this.unit=o,this.drawDelayTime=h,this.exportImageDelayTime=s,this.drawTipsText=i,this.exportImageTips=m,this.fontStyle=u({size:this.type==="default"?16:32,family:"sans-serif",style:"normal",variant:"normal",weight:"normal"},w),this.commonUtilMethods=new $.CommonUtilMethods({unit:o,type:this.type,width:a,height:e,fontStyle:this.fontStyle}),this.setCanvasStyle(a,e),this.exportImageStyle=u({width:a,height:e,x:0,y:0,fileType:"png",quality:1},f),this.allCallback=[],this.$eventsMap=new Map,this.createContext(),this.drawCallback=null}async createContext(){const{width:t,height:a,canvasId:e,_this:n,type:l,is2d:r}=this,c=(h,s=null)=>{this.Context=h,this.canvas=s,this.commonDrawMethods=new $.CommonDrawMethods(h,l,this.commonUtilMethods),this.commonUtilMethods.Context=h,this.commonUtilMethods.canvas=s,this.initDrawMethods(),this.$emit("init")},o=C.index.getSystemInfoSync().pixelRatio;if(this.dpr=o,r)C.index.createSelectorQuery().select(`#${e}`).fields({node:!0,size:!0}).exec(h=>{const s=h[0].node,i=s.getContext(l);s.width=this.commonUtilMethods.getConvertedValue(t)*o,s.height=this.commonUtilMethods.getConvertedValue(a)*o,i.scale(o,o),c(i,s)});else{const h=C.index.createCanvasContext(e,n);await $.sleep(50),c(h)}}initDrawMethods(){const{Context:t,commonUtilMethods:a,commonDrawMethods:e}=this,n={Context:t,commonUtilMethods:a,commonDrawMethods:e};this.canvasMethods=new tt.Canvas(this);const l=new X.DrawText(n),r=new G.drawLine(n),c=new J.DrawRect(n),o=new K.DrawArc(n),h=new q.DrawImage(n),s=new Y.DrawTriangle(n),i=new Z.DrawQrcode(n);this.commonDrawMethods.drawParams={drawText:l,drawLine:r,drawRect:c,drawArc:o,drawImage:h,drawTriangle:s,drawQrcode:i},this.drawText=l,this.drawLine=r,this.drawRect=c,this.drawArc=o,this.drawImage=h,this.drawTriangle=s,this.drawQrcode=i}setExportImageStyle(t){this.exportImageStyle=u(u({},this.exportImageStyle),t)}setBackgroundStyle(t){this.background=u(u({},this.background),t)}async setCanvasStyle(t,a){if(this.width=t,this.height=a,this.commonUtilMethods.width=t,this.commonUtilMethods.height=a,this.commonUtilMethods.setCanvasStyle(),this.callbackInfo={bgObj:{width:this.background.w,height:this.background.h},ctxObj:{width:t,height:a}},this.setExportImageStyle({width:t,height:a}),this.canvas){const{dpr:e,canvas:n,Context:l,commonUtilMethods:r}=this;n.width=r.getConvertedValue(t)*e,n.height=r.getConvertedValue(a)*e,l.scale(e,e),await this.drawBackground(!1),this.drawArrayFn&&await this.drawCanvas(this.drawArrayFn(this.callbackInfo),!1)}}$on(t="",a=null){if(!t||!a||typeof a!="function")return;let e=this.$eventsMap.get(t);e||this.$eventsMap.set(t,e=new Set),e.add(a),this.$eventsMap.set(t,e)}$emit(t="",a={}){if(!t)return;const e=this.$eventsMap.get(t);e&&e.forEach(n=>{n(a)})}drawBackground(t=!0){const{background:a,width:e,height:n,Context:l,drawRect:r,drawImage:c,unit:o,commonUtilMethods:h}=this;return new Promise(async s=>{var p,M,y,x,I;const f=a,{type:i}=f,m=P(f,["type"]);t||this.canvasMethods.clearCanvas();let w={};i==="color"?w=r.draw(A(u({},m),{w:(p=m.w)!=null?p:e,h:(M=m.h)!=null?M:n,color:(y=m.color)!=null?y:"#ffffff"})):i==="image"&&(w=await c.draw(A(u({},m),{w:(x=m.w)!=null?x:e,h:(I=m.h)!=null?I:n}))),w.style={width:w.w+o,height:w.h+o},this.background.w=w.w,this.background.h=w.h,t&&this.$emit("background",w),s(w)})}async setAllCallBack(t){const{width:a,commonUtilMethods:e,commonDrawMethods:n}=this,{canvasWidth:l}=e;let{type:r,x:c=0,y:o=0,r:h=0,w:s=l,h:i=0,lineWidth:m=1,size:w=0,name:f="",windowAlign:p="none",drawType:M="default",mode:y="aspectFill",src:x="",offsetRight:I}=t,R=c,U=o,k=c+s,g=o+i;if(r==="text"){let{text:b,textIndent:_,lastWidth:T,font:V,line:L,textAlign:B,windowAlign:F,color:D}=this.drawText.getDrawParams(t,!1);const v=n.computedFontTextLineHeight(c,o,s,b,_,T,V,L,B,F,D),Q=v[v.length-1],j=v[0];g=Q.ey,k=j.tx+j.w,t.textArr=e.conversionUnit(v),t.h=g-U,t.tw=j.w}else if(r==="arc")k=c+h*2,g=o+h*2,s=h*2,i=h*2;else if(r==="line")g=o+m,i=m;else if(r==="qrcode")k=c+w,g=o+w,s=w,i=w;else if(r=="image"){p!=="none"&&(c=n.computedCenterX(a,s,p,I));const b=await q.getImageSrc(x);if(!b.success)return b;x=b.src;const _=await q.getImageInfo(x);if(!_.success)return Promise.resolve(!0);const T=q.getModeImage(Number(_.width),Number(_.height),e.getConvertedValue(c),e.getConvertedValue(o),e.getConvertedValue(s),e.getConvertedValue(i),y),{dx:V,dy:L,dw:B,dh:F,sw:D,sh:v,sx:Q,sy:j}=T;y==="widthFix"?(i=this.unit==="rpx"?e.pxToRpx(v):v,g=o+i):y==="heightFix"&&(s=this.unit==="rpx"?e.pxToRpx(D):D,k=c+s),M==="arc"&&i==0&&(i=s,g=o+i),t.drawModeImage=T,t.drawSrc=x,t.drawImageInfo=_}return t.sx=R,t.sy=U,t.ex=k,t.ey=g,this.allCallback.push({sx:R,sy:U,ex:k,ey:g,w:s,h:i,name:f,before:t.before||{}}),Promise.resolve(!0)}drawCanvas(t,a=!0){const{Context:e}=this;return new Promise(async n=>{try{for(let s of t){if(s.callback&&typeof s.callback=="function"&&s.type!=="custom"){const i=this.allCallback.length==0?{}:this.allCallback[this.allCallback.length-1],m=s.callback(i,this.allCallback)||{},l=s,{callback:w}=l,f=P(l,["callback"]);s=u(u({},f),m)}switch(s.type!=="custom"&&s.drawType!=="custom"&&await this.setAllCallBack(s),s.type){case"text":this.drawText.draw(s);break;case"rect":this.drawRect.draw(s);break;case"image":const i=await this.drawImage.draw(s);if(!i.success)return n(i);break;case"arc":this.drawArc.draw(s);break;case"triangle":this.drawTriangle.draw(s);break;case"line":this.drawLine.draw(s);break;case"qrcode":await this.drawQrcode.draw(s);break;case"custom":s.setDraw(e,this);break}}if(n({success:!0}),!a)return;const{width:r,height:c}=this,o=this.allCallback.reduce((s,i)=>Math.max(s,i.ey),0),h=this.allCallback.reduce((s,i)=>Math.max(s,i.ex),0);this.$emit("drawComplete",{width:r,height:c,contentHeight:o,contentWidth:h})}catch(r){return n({success:!1,msg:"\u7ED8\u5236\u5185\u5BB9\u5931\u8D25:"+r})}finally{C.index.hideLoading()}})}drawPoster(t){const{callbackInfo:a,drawTipsText:e}=this;return new Promise(async n=>{if(!t||typeof t!="function")return n({success:!1,msg:"drawPoster\u53C2\u6570\u9519\u8BEF"});this.drawArrayFn&&(this.allCallback=[],this.canvasMethods.clearCanvas(),await this.drawBackground(!1)),this.drawArrayFn=t,C.index.showLoading({title:e});const l=await this.drawCanvas(t(a));if(!l.success)return n(l);n(await this.canvasMethods.canvasDraw()),C.index.hideLoading()})}}exports.DrawPoster=et;
