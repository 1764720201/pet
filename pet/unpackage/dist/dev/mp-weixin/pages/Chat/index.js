"use strict";var e=require("../../common/vendor.js");if(!Array){const f=e.resolveComponent("uni-file-picker"),r=e.resolveComponent("uni-popup");(f+r)()}const B=()=>"../../uni_modules/uni-file-picker/components/uni-file-picker/uni-file-picker.js",T=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||(B+T)();const U=e.defineComponent({__name:"index",setup(f){const r=e.ref(!1);let m=50;const d=e.pn.database(),c=e.ref(),h=e.ref("calc(100vh - 300rpx)"),n=e.ref(""),b=e.pn.importObject("uni-id-co"),o=e.ref([]),s=e.ref(""),v=e.ref(!1),k=async t=>{const i=e.ref(!0);t.detail.scrollTop<1550&&i.value&&(m+=50,i.value=!1,await _(),i.value=!0)};e.index.getPushClientId({async success(t){await b.setPushCid({pushClientId:t.cid})}});const l=e.reactive({avatar_file:{url:""},nickname:"",_id:""}),u=e.reactive({avatar_file:{url:""},nickname:"",_id:""});e.onLoad(async t=>{var i;n.value=t.id,await g(`_id=='${t.id}'`,l),await g("_id==$cloudEnv_uid",u),await _(),await C(),await x(),c.value="msg"+((i=o.value[o.value.length-1])==null?void 0:i._id)});const g=async(t,i)=>{await d.collection("uni-id-users").where(t).field("nickname,avatar_file").get({getOne:!0}).then(a=>{Object.assign(i,a.result.data)})};e.index.onPushMessage(async()=>{var t;await _(),c.value="msg"+((t=o.value[o.value.length-1])==null?void 0:t._id)});const x=async()=>{await d.collection("chat").field("from_uid,to_uid,is_read").where(`from_uid=='${n.value}'&&to_uid==$cloudEnv_uid&&is_read==false`).update({is_read:!0})},y=e.ref(),_=async()=>{await d.collection("chat").where(`(from_uid==$cloudEnv_uid&&to_uid=='${n.value}')||(from_uid=='${n.value}'&&to_uid==$cloudEnv_uid)`).orderBy("create_date","desc").limit(m).get().then(t=>{o.value=t.result.data.reverse()})},C=async()=>{await d.collection("chat").where(`from_uid=='${n.value}'&&to_uid==$cloudEnv_uid&&is_read==false`).orderBy("create_date","desc").get().then(t=>{var a;t.result.data.length>10&&(v.value=!0,y.value="msg"+((a=t.result.data[0])==null?void 0:a._id))})},P=()=>{c.value=y.value,v.value=!1},$=async()=>{r.value=!0,s.value?(e.pn.callFunction({name:"push",data:{userId:n.value,content:s.value},fail(t){console.log(t)}}),await d.collection("chat").add({to_uid:n.value,body:{text:s.value},type:"text"}).then(async()=>{var t;await _(),c.value="msg"+((t=o.value[o.value.length-1])==null?void 0:t._id),s.value=""}).catch(t=>{console.log(t)})):e.index.showToast({title:"\u8BF7\u8F93\u5165\u6587\u5B57!",icon:"none"})},p=e.ref(null),j=()=>{p.value.open()},F=e.reactive({width:74,height:74,border:{color:"#afafaf",radio:10}}),w=e.ref(null),I=async()=>{await p.value.close()},E=async t=>{r.value=!0,t.tempFilePaths.forEach(async i=>{e.pn.callFunction({name:"push",data:{userId:n.value,content:s.value}}),await d.collection("chat").add({to_uid:n.value,body:{image:i},type:"image"}).then(async()=>{var a;await _(),c.value="msg"+((a=o.value[o.value.length-1])==null?void 0:a._id),w.value.clearFiles()})})};return(t,i)=>e.e({a:v.value},v.value?{b:e.o(P)}:{},{c:e.f(o.value,(a,M,O)=>e.e({a:a.from_uid==(u==null?void 0:u._id)},a.from_uid==(u==null?void 0:u._id)?e.e({b:e.t(u.nickname),c:u.avatar_file.url,d:a.type=="text"},a.type=="text"?{e:e.t(a.body.text)}:{},{f:a.type=="image"},a.type=="image"?{g:a.body.image}:{}):{},{h:a.from_uid==(l==null?void 0:l._id)},a.from_uid==(l==null?void 0:l._id)?e.e({i:l.avatar_file.url,j:e.t(l.nickname),k:a.type=="text"},a.type=="text"?{l:e.t(a.body.text)}:{},{m:a.type=="image"},a.type=="image"?{n:a.body.image}:{}):{},{o:a==null?void 0:a._id,p:"msg"+(a==null?void 0:a._id)})),d:e.o(k),e:c.value,f:h.value,g:r.value,h:s.value,i:e.o(a=>s.value=a.detail.value),j:e.o(j),k:e.o($),l:e.sr(w,"b75d0198-1,b75d0198-0",{k:"clear"}),m:e.o(E),n:e.o(I),o:e.p({["del-icon"]:!1,limit:"6",imageStyles:F}),p:e.sr(p,"b75d0198-0",{k:"popup"}),q:e.p({type:"bottom",backgroundColor:"#fff"})})}});var L=e._export_sfc(U,[["__scopeId","data-v-b75d0198"],["__file","C:/Users/yzc/Desktop/pet/pages/Chat/index.vue"]]);wx.createPage(L);
