"use strict";var e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}Math||(a+t+u+i+n+o+r+(()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js")+l)();const t=()=>"./PetInformation/index.js",n=()=>"../../components/AuthorInformation/index.js",a=()=>"./PetAppearance/index.js",i=()=>"./Applied/index.js",o=()=>"./Explain/index.js",l=()=>"./Inferior/index.js",u=()=>"./Remind/index.js",r=()=>"../../components/Message/index.js",d=e.defineComponent({__name:"index",setup(t){const n=e.ref("");e.onShow((()=>{n.value=e.pn.getCurrentUserInfo().uid}));const a=e.pn.database(),i=e.ref([]),o=e.reactive({nickname:"",imgURL:"",id:""}),l=e.reactive({nickname:"",imgURL:""}),u=e.reactive({_id:"",age:"",city:[],gender:"",img:[],medical:[],name:"",particular:[],pet_name:"",phone:"",punch:"",request:[""],source:[""],story:"",variety:"",wx_code:"",issue_time:0,user_id:"",if_adopt:!1}),r=()=>{e.index.navigateTo({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd?type=weixin"})},d=e.ref(),p=e.ref(),s=e.ref(null),c=e.ref();let m=e.ref(!0);const v=()=>{if(n.value=e.pn.getCurrentUserInfo().uid,c.value)if(n.value){if(!m.value)return;m.value=!1,e.pn.callFunction({name:"comment",data:{comment:c.value,type:0,userId:n.value,adoptId:u._id,avatarUrl:l.imgURL,nickname:l.nickname}}).then((()=>{c.value="",e.index.showToast({title:"评论成功"}),f(),setTimeout((()=>{m.value=!0}),3e3)})).catch((e=>{console.log(e)}))}else s.value.open("center");else e.index.showToast({title:"请输入文字",icon:"none"})},g=e.ref([]),_=e.ref([]),f=()=>{a.collection("comment").where(d.value).get().then((e=>{_.value=e.result.data}))},h=e.ref(),x=e.ref([]);e.onLoad((async t=>{n.value=e.pn.getCurrentUserInfo().uid,await a.collection("adoption").where(`_id == '${t.id}'`).get().then((e=>{Object.assign(u,e.result.data[0]),d.value=`adopt_id=='${u._id}'&&comment_type==0`,p.value=`comment_type==1&&adopt_id=='${u._id}'`,f()})).then((async()=>{k(),await a.collection("uni-id-users").where(`_id == '${n.value}'`).field("nickname,avatar_file").get().then((e=>{var t;l.nickname=e.result.data[0].nickname,l.imgURL=null==(t=e.result.data[0].avatar_file)?void 0:t.url}))})).then((()=>{a.collection("uni-id-users").where(`_id=='${u.user_id}'`).get().then((e=>{var t;o.imgURL=null==(t=e.result.data[0].avatar_file)?void 0:t.url,o.nickname=e.result.data[0].nickname,o.id=e.result.data[0]._id}))})).then((()=>{a.collection("apply").where(`adopt_id=='${u._id}'&&state=='申请中'`).field("user_id").get().then((e=>{x.value=e.result.data}))})).then((()=>{a.collection("images").where("title=='没有同城'").get().then((e=>{h.value=e.result.data[0].image[0].url}))})).then((()=>{a.collection("comment").where("comment_type==1").get().then((e=>{g.value=e.result.data}))})).catch((e=>{console.log(e.code),console.log(e.message)}))}));const w=e.ref(0),y=e.ref(),k=()=>{a.collection("adoption").where(`city=='${u.city[1]}'&&_id!='${u._id}'`).field("pet_name as petName,_id,img").skip(w.value).limit(3).get({getCount:!0}).then((e=>{i.value=e.result.data,y.value=e.result.count}))},j=()=>{w.value>=y.value||w.value+3>=y.value?(w.value=0,e.index.showToast({title:"没有更多了",icon:"none"}),k()):(w.value+=3,k())};return(t,n)=>e.e({a:e.p({petInfo:u}),b:e.p({petInfo:u}),c:e.p({applyList:x.value}),d:e.p({nickname:o.nickname,avatarUrl:o.imgURL,userId:o.id,wxCode:u.wx_code,phone:u.phone,title:"送养人信息"}),e:e.o(j),f:i.value},i.value?{g:e.f(i.value,((t,n,a)=>{var i;return{a:null==(i=null==t?void 0:t.img[0])?void 0:i.url,b:e.t(t.petName),c:t._id,d:e.o((n=>(t=>{e.index.navigateTo({url:`/pages/ApplyAdopt/index?id=${t._id}`})})(t)),t._id)}}))}:{},{h:!i.value[0]},i.value[0]?{}:{i:h.value},{j:c.value,k:e.o((e=>c.value=e.detail.value)),l:e.o(v),m:e.p({commentList:_.value,where:p.value}),n:e.o(r),o:e.p({type:"warn",cancelText:"暂不登录",confirmText:"前往登录",title:"提醒",content:"您还未登录,是否要前往登录"}),p:e.sr(s,"c53b2f80-7",{k:"alertDialog"}),q:e.p({type:"dialog"}),r:e.p({petInfo:u})})}});var p=e._export_sfc(d,[["__scopeId","data-v-c53b2f80"]]);wx.createPage(p);
