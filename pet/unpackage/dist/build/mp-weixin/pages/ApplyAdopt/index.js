"use strict";var e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-dateformat")+e.resolveComponent("tui-icon")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}Math||(a+n+u+i+t+o+(()=>"../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../node-modules/thorui-uni/lib/thorui/tui-icon/tui-icon.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js")+l)();const n=()=>"./PetInformation/index.js",t=()=>"../../components/AuthorInformation/index.js",a=()=>"./PetAppearance/index.js",i=()=>"./Applied/index.js",o=()=>"./Explain/index.js",l=()=>"./Inferior/index.js",u=()=>"./Remind/index.js",d=e.defineComponent({__name:"index",setup(n){const t=e.ref("");e.onShow((()=>{t.value=e.pn.getCurrentUserInfo().uid}));const a=e.pn.database(),i=e.ref([]),o=e.reactive({nickname:"",imgURL:"",id:""}),l=e.reactive({nickname:"",imgURL:""}),u=e.reactive({_id:"",age:"",city:[],gender:"",img:[],medical:[],name:"",particular:[],pet_name:"",phone:"",punch:"",request:[""],source:[""],story:"",variety:"",wx_code:"",issue_time:0,user_id:"",if_adopt:!1}),d=()=>{e.index.navigateTo({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd?type=weixin"})},r=e.ref(null),c=e.ref();let s=e.ref(!0);const m=()=>{if(t.value=e.pn.getCurrentUserInfo().uid,c.value)if(t.value){if(!s.value)return;s.value=!1,e.pn.callFunction({name:"comment",data:{commentContent:c.value,commentType:0,userId:t.value,adoptId:u._id,avatarUrl:l.imgURL,nickname:l.nickname}}).then((()=>{w(),c.value="",e.index.showToast({title:"评论成功"}),setTimeout((()=>{s.value=!0}),3e3)})).catch((e=>{console.log(e)}))}else r.value.open("center");else e.index.showToast({title:"请输入文字",icon:"none"})},p=e.ref(null),v=e.ref(),f=e.ref(),_=n=>{t.value=e.pn.getCurrentUserInfo().uid,n?t.value?e.pn.callFunction({name:"comment",data:{commentContent:n,commentType:1,userId:t.value,adoptId:u._id,avatarUrl:l.imgURL,nickname:l.nickname,commentId:f.value}}).then((()=>{e.index.showToast({title:"评论成功",icon:"none"}),x()})):r.value.open("center"):e.index.showToast({title:"请输入文字",icon:"none"})},g=e.ref([]);let h=e.ref([]);const w=()=>{const e=a.collection("adoption").where(`_id=='${u._id}'`).field("_id").getTemp(),n=a.collection("comment").where("comment_type==0").orderBy("create_time","desc").getTemp();a.collection(e,n).get().then((e=>{h.value=e.result.data[0]._id.comment}))},x=()=>{a.collection("comment").where("comment_type==1").get().then((e=>{g.value=e.result.data}))},y=e.ref(),k=e.ref([]);e.onLoad((async n=>{t.value=e.pn.getCurrentUserInfo().uid,await a.collection("adoption").where(`_id == '${n.id}'`).get().then((e=>{Object.assign(u,e.result.data[0])})).then((async()=>{C(),await a.collection("uni-id-users").where(`_id == '${t.value}'`).field("nickname,avatar_file").get().then((e=>{var n;l.nickname=e.result.data[0].nickname,l.imgURL=null==(n=e.result.data[0].avatar_file)?void 0:n.url}))})).then((()=>{a.collection("uni-id-users").where(`_id=='${u.user_id}'`).get().then((e=>{var n;o.imgURL=null==(n=e.result.data[0].avatar_file)?void 0:n.url,o.nickname=e.result.data[0].nickname,o.id=e.result.data[0]._id}))})).then((()=>{a.collection("apply").where(`adopt_id=='${u._id}'&&state=='申请中'`).field("user_id").get().then((e=>{k.value=e.result.data}))})).then((()=>{a.collection("images").where("title=='没有同城'").get().then((e=>{y.value=e.result.data[0].image[0].url}))})).then((()=>{w(),x()})).catch((e=>{console.log(e.code),console.log(e.message)}))}));const I=e.ref(0),j=e.ref(),C=()=>{a.collection("adoption").where(`city=='${u.city[1]}'&&_id!='${u._id}'`).field("pet_name as petName,_id,img").skip(I.value).limit(3).get({getCount:!0}).then((e=>{i.value=e.result.data,j.value=e.result.count}))},T=()=>{I.value>=j.value||I.value+3>=j.value?(I.value=0,e.index.showToast({title:"没有更多了",icon:"none"}),C()):(I.value+=3,C())};return(n,t)=>e.e({a:e.p({petInfo:u}),b:e.p({petInfo:u}),c:e.p({applyList:k.value}),d:e.p({nickname:o.nickname,avatarUrl:o.imgURL,userId:o.id,wxCode:u.wx_code,phone:u.phone,title:"送养人信息"}),e:e.o(T),f:i.value},i.value?{g:e.f(i.value,((n,t,a)=>({a:n.img[0].url,b:e.t(n.petName),c:n._id,d:e.o((t=>(n=>{e.index.navigateTo({url:`/pages/ApplyAdopt/index?id=${n._id}`})})(n)),n._id)})))}:{},{h:!i.value[0]},i.value[0]?{}:{i:y.value},{j:c.value,k:e.o((e=>c.value=e.detail.value)),l:e.o(m),m:e.f(e.unref(h),((n,t,a)=>({a:n.avatar_url,b:e.t(n.nickname),c:"2f78cd80-6-"+a,d:e.p({date:n.create_time,format:"yyyy-MM-dd hh:mm:ss"}),e:e.o((e=>(async e=>{v.value=e.nickname,f.value=e._id,p.value.open("center")})(n))),f:"2f78cd80-7-"+a,g:e.t(n.comment),h:e.f(g.value,((t,a,i)=>e.e({a:t.comment_id==n._id},t.comment_id==n._id?{b:e.t(t.nickname),c:e.t(t.comment)}:{},{d:t._id}))),i:n._id}))),n:e.p({name:"message"}),o:e.o(d),p:e.p({type:"warn",cancelText:"暂不登录",confirmText:"前往登录",title:"提醒",content:"您还未登录,是否要前往登录"}),q:e.sr(r,"2f78cd80-8",{k:"alertDialog"}),r:e.p({type:"dialog"}),s:e.sr("inputClose","2f78cd80-11,2f78cd80-10"),t:e.o(_),v:e.p({title:"回复",mode:"input",placeholder:"@"+v.value}),w:e.sr(p,"2f78cd80-10",{k:"inputDialog"}),x:e.p({type:"dialog"}),y:e.p({petInfo:u})})}});var r=e._export_sfc(d,[["__scopeId","data-v-2f78cd80"]]);wx.createPage(r);
