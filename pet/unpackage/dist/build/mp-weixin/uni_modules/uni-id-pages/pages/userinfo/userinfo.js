"use strict";var e=require("../../../../common/vendor.js");const i=e.pn.database().collection("uni-id-users"),o=e.pn.importObject("uni-id-co"),n={data:()=>({univerifyStyle:{authButton:{title:"本机号码一键绑定"},otherLoginButton:{title:"其他号码绑定"}},userInfo:{mobile:"",nickname:""},hasLogin:!1,hasPwd:!1}),async onShow(){this.univerifyStyle.authButton.title="本机号码一键绑定",this.univerifyStyle.otherLoginButton.title="其他号码绑定"},async onLoad(){this.getUserInfo();let e=await o.getAccountInfo();this.hasPwd=e.isPasswordSet},methods:{login(){e.index.navigateTo({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd",complete:e=>{console.log(e)}})},async logout(){await o.logout(),e.index.removeStorageSync("uni_id_token"),e.index.setStorageSync("uni_id_token_expired",0),e.index.redirectTo({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"})},changePassword(){e.index.navigateTo({url:"/uni_modules/uni-id-pages/pages/userinfo/change_pwd/change_pwd",complete:e=>{console.log(e)}})},getUserInfo(o){e.index.showLoading({mask:!0}),i.where("'_id' == $cloudEnv_uid").field("mobile,nickname").get().then((e=>{console.log({res:e}),this.userInfo=e.result.data[0],console.log("this.userInfo",this.userInfo),this.hasLogin=!0})).catch((e=>{this.userInfo={},this.hasLogin=!1,console.log(e.message,e.errCode)})).finally((i=>{e.index.hideLoading()}))},bindMobile(){this.$refs["bind-mobile"].open()},univerify(){e.index.login({provider:"univerify",univerifyStyle:this.univerifyStyle,success:async i=>{console.log(i.authResult),o.bindMobileByUniverify(i.authResult).then((e=>{console.log(e),this.getUserInfo()})).catch((e=>{console.log(e)})).finally((i=>{console.log(i),e.index.closeAuthView()}))},fail:e=>{console.log(e),"30002"!=e.code&&"30001"!=e.code||this.bindMobileBySmsCode()}})},bindMobileBySmsCode(){e.index.navigateTo({url:"./bind-mobile/bind-mobile",events:{getUserInfo:()=>{this.getUserInfo()}},complete(e){console.log(e)}})},setNickname(o){console.log(o),o?(i.where("_id==$env.uid").update({nickname:o}).then((i=>{console.log(i),i.result.updated?(e.index.showToast({title:"更新成功",icon:"none"}),this.userInfo.nickname=o):e.index.showToast({title:"没有改变",icon:"none"})})),this.$refs.dialog.close()):this.$refs.dialog.open()},deactivate(){e.index.navigateTo({url:"/uni_modules/uni-id-pages/pages/userinfo/deactivate/deactivate"})}}};if(!Array){(e.resolveComponent("uni-id-pages-avatar")+e.resolveComponent("uni-list-item")+e.resolveComponent("uni-list")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup")+e.resolveComponent("uni-id-pages-bind-mobile"))()}Math||((()=>"../../components/uni-id-pages-avatar/uni-id-pages-avatar.js")+(()=>"../../../uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../../uni-list/components/uni-list/uni-list.js")+(()=>"../../../uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../../uni-popup/components/uni-popup/uni-popup.js")+(()=>"../../components/uni-id-pages-bind-mobile/uni-id-pages-bind-mobile.js"))();var t=e._export_sfc(n,[["render",function(i,o,n,t,s,l){return e.e({a:e.p({width:"260rpx",height:"260rpx"}),b:e.o((e=>l.setNickname(""))),c:e.p({title:"昵称",rightText:s.userInfo.nickname||"未设置",link:!0}),d:e.o(l.bindMobile),e:e.p({title:"手机号",rightText:s.userInfo.mobile||"未绑定",link:!0}),f:s.hasPwd},s.hasPwd?{g:e.o(l.changePassword),h:e.p({title:"修改密码",link:!0})}:{},{i:e.o(l.deactivate),j:e.p({title:"注销账号",link:"navigateTo"}),k:e.o(l.setNickname),l:e.p({mode:"input",value:s.userInfo.nickname,title:"设置昵称",placeholder:"请输入要设置的昵称"}),m:e.sr("dialog","5614a912-7"),n:e.p({type:"dialog"}),o:e.sr("bind-mobile-by-sms","5614a912-9"),p:e.o(l.getUserInfo),q:s.hasLogin},s.hasLogin?{r:e.o(((...e)=>l.logout&&l.logout(...e)))}:{s:e.o(((...e)=>l.login&&l.login(...e)))})}],["__scopeId","data-v-5614a912"]]);wx.createPage(t);
