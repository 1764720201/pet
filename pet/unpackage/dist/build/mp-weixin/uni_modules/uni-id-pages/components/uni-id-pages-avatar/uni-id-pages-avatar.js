"use strict";var e=require("../../../../common/vendor.js");const i=e.pn.database().collection("uni-id-users"),t={data:()=>({userInfo:{},isPC:!1,hasLogin:!1}),props:{width:{type:String,default:()=>"50px"},height:{type:String,default:()=>"50px"}},async mounted(){i.where("'_id' == $cloudEnv_uid").field("avatar_file,mobile,nickname").get().then((e=>{this.userInfo=e.result.data[0]||{},console.log("this.userInfo",this.userInfo),this.hasLogin=!0})).catch((e=>{this.userInfo={},this.hasLogin=!1,console.log(e.message,e.errCode)}))},computed:{avatar_file(){if(this.userInfo.avatar_file&&this.userInfo.avatar_file.url)return this.userInfo.avatar_file}},methods:{setAvatarFile(t){e.index.showLoading({title:"设置中",mask:!0}),i.where("_id==$env.uid").update({avatar_file:t}).then((i=>{console.log(i),t?e.index.showToast({icon:"none",title:"更新成功"}):e.index.showToast({icon:"none",title:"删除成功"}),this.$set(this.userInfo,"avatar_file",t)})).catch((i=>{e.index.showModal({content:i.message||"请求失败",showCancel:!1})})).finally((()=>{e.index.hideLoading()}))},uploadAvatarImg(i){if(!this.hasLogin)return e.index.navigateTo({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"});const t={quality:100,width:600,height:600,resize:!0};e.index.chooseImage({count:1,crop:t,success:async i=>{console.log(i);let a=i.tempFiles[0],o={extname:a.path.split(".")[a.path.split(".").length-1]},n=i.tempFilePaths[0];this.isPC||(n=await new Promise((i=>{e.index.navigateTo({url:"/uni_modules/uni-id-pages/pages/userinfo/cropImage/cropImage?path="+n+`&options=${JSON.stringify(t)}`,animationType:"fade-in",events:{success:e=>{i(e)}},complete(e){console.log(e)}})}))),console.log(this.userInfo);let s=this.userInfo._id+""+Date.now();o.name=s,e.index.showLoading({title:"更新中",mask:!0});let{fileID:l}=await e.pn.uploadFile({filePath:n,cloudPath:s,fileType:"image"});o.url=l,console.log({avatar_file:o}),e.index.hideLoading(),this.setAvatarFile(o)}})}}};if(!Array){(e.resolveComponent("cloud-image")+e.resolveComponent("uni-icons"))()}Math||((()=>"../cloud-image/cloud-image.js")+(()=>"../../../uni-icons/components/uni-icons/uni-icons.js"))();var a=e._export_sfc(t,[["render",function(i,t,a,o,n,s){return e.e({a:s.avatar_file},s.avatar_file?{b:e.p({src:s.avatar_file.url,width:a.width,height:a.height})}:{c:a.width,d:a.height,e:a.height,f:e.p({type:"plusempty",size:"30",color:"#dddddd"})},{g:e.o(((...e)=>s.uploadAvatarImg&&s.uploadAvatarImg(...e)))})}]]);wx.createComponent(a);
