"use strict";var e=Object.defineProperty,i=Object.defineProperties,t=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,l=(i,t,o)=>t in i?e(i,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[t]=o,a=(e,i)=>{for(var t in i||(i={}))n.call(i,t)&&l(e,t,i[t]);if(o)for(var t of o(i))s.call(i,t)&&l(e,t,i[t]);return e},r=(e,o)=>i(e,t(o)),g=require("../../../../common/vendor.js"),u=require("../../config.js"),c=require("../../common/loginSuccess.js");g.pn.database().collection("uni-id-users");const d={computed:{agreements(){if(!u.config.agreements)return[];let{serviceUrl:e,privacyUrl:i}=u.config.agreements;return[{url:e,title:"用户服务协议"},{url:i,title:"隐私政策条款"}]},agree:{get(){return this.getParentComponent().agree},set(e){return console.log("setAgree",e),this.getParentComponent().agree=e}}},data:()=>({servicesList:[{id:"username",text:"账号登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/user.png",path:"/uni_modules/uni-id-pages/pages/login/login-withpwd"},{id:"smsCode",text:"短信验证码",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/sms.png",path:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd?type=smsCode"},{id:"weixin",text:"微信登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/weixin.png"},{id:"apple",text:"苹果登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/apple.png"},{id:"univerify",text:"一键登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/univerify.png"},{id:"taobao",text:"淘宝登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/taobao.png"},{id:"facebook",text:"脸书登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/facebook.png"},{id:"alipay",text:"支付宝登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/alipay.png"},{id:"qq",text:"QQ登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/qq.png"},{id:"google",text:"谷歌登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/google.png"},{id:"douyin",text:"抖音登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/douyin.png"},{id:"sinaweibo",text:"新浪微博",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/sinaweibo.png"}],univerifyStyle:{fullScreen:!0,backgroundColor:"#ffffff",buttons:{iconWidth:"45px",list:[]},privacyTerms:{defaultCheckBoxState:!1,textColor:"#BBBBBB",termsColor:"#5496E3",prefix:"我已阅读并同意",suffix:"并使用本机号码登录",privacyItems:[]}}}),watch:{agree(e){this.univerifyStyle.privacyTerms.defaultCheckBoxState=e}},async created(){let e=this.servicesList,i=u.config.loginTypes;e=e.filter((e=>"apple"!=e.id&&i.includes(e.id))),i.includes("univerify")&&(this.univerifyStyle.privacyTerms.privacyItems=this.agreements,e.forEach((({id:e,logo:i,path:t})=>{"univerify"!=e&&this.univerifyStyle.buttons.list.push({iconPath:i,provider:e,path:t})}))),this.servicesList=e.filter((e=>(e.path?e.path.split("?")[0]:"")!=this.getRoute(1)))},methods:{getParentComponent(){return this.$parent},setUserInfo(e){console.log("setUserInfo",e)},getRoute(e=0){let i=getCurrentPages();return e>i.length?"":"/"+i[i.length-e].route},navigateTo(e){if(this.getRoute(1)==e.split("?")[0]&&"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"==this.getRoute(1)){let i=e.split("?")[1].split("=")[1];g.index.$emit("uni-id-pages-set-login-type",i)}else this.getRoute(2)==e?g.index.navigateBack():this.getRoute(1)!=e?g.index.navigateTo({url:e,animationType:"slide-in-left",complete(e){}}):console.log("出乎意料的情况,path："+e)},async login_before(e,i=!0){var t,o;if(console.log(e),["qq","xiaomi","sinaweibo","taobao","facebook","google","alipay","douyin"].includes(e))return g.index.showToast({title:"该登录方式暂未实现，欢迎提交pr",icon:"none"});if(["univerify","apple"].includes(e))return g.index.showToast({title:"当前设备不支持此登录，请选择其他登录方式",icon:"none"});console.log(e,this.agree);let n=((null==(o=null==(t=u.config)?void 0:t.agreements)?void 0:o.scope)||[]).includes("register");if(console.log({needAgreements:n}),"univerify"!=e&&n&&!this.agree){return this.getParentComponent().$refs.agreements.popup((()=>{console.log(e,i),this.login_before(e,i)}))}if("univerify"==e){let e=function(){g.index.hideLoading(),i.close(),i.offButtonsClick(t)},i=g.index.getUniverifyManager(),t=async i=>{console.log("点击了第三方登录，provider：",i,i.provider,this.univerifyStyle.buttons.list);let t=(await g.index.getCheckBoxState())[1].state;this.agree=t;let{path:o}=this.univerifyStyle.buttons.list[i.index];o?(this.navigateTo(o),e()):t?(e(),setTimeout((()=>{this.login_before(i.provider)}),500)):g.index.showToast({title:"你未同意隐私政策协议",icon:"none"})};return i.onButtonsClick(t),i.login({univerifyStyle:this.univerifyStyle,success:e=>{console.log("login success",e),this.login(e.authResult,"univerify")},fail(e){g.index.showToast({title:JSON.stringify(e),icon:"none"})},complete:async e=>{console.log(e),g.index.hideLoading(),this.agree=(await g.index.getCheckBoxState())[1].state,i.offButtonsClick(t)}})}g.index.showLoading({mask:!0}),g.index.login({provider:e,onlyAuthorize:!0,success:async i=>{if(console.log(i),"apple"==e){let e=await this.getUserInfo({provider:"apple"});Object.assign(i.authResult,e.userInfo),g.index.hideLoading()}this.login("weixin"==e?{code:i.code}:i.authResult,e)},fail:async e=>{console.log(e),g.index.hideLoading()}})},login(e,i){console.log("执行登录开始----"),console.log({params:e,type:i});let t="loginBy"+i.trim().toLowerCase().replace(i[0],i[0].toUpperCase());g.pn.importObject("uni-id-co",{customUI:!0})[t](e).then((e=>{if(console.log("login-result",e),g.index.showToast({title:"登录成功",icon:"none"}),"weixin"==i&&"register"==e.type)return c.loginSuccess(r(a({},e),{showToast:!1,autoBack:!1})),this.$refs.userProfile.open(e.uid);c.loginSuccess(e)})).catch((e=>{console.log(e),g.index.showModal({content:e.message,confirmText:"知道了",showCancel:!1})})).finally((e=>{"univerify"==i&&g.index.closeAuthView(),g.index.hideLoading()}))},doUserProfileNext(){try{c.loginSuccess()}catch(e){console.log(e)}},getUserInfo:async e=>new Promise(((i,t)=>{g.index.getUserInfo(r(a({},e),{success:e=>{i(e)},fail:e=>{g.index.showModal({content:JSON.stringify(e),showCancel:!1}),t(e)}}))}))}};if(!Array){g.resolveComponent("uni-id-pages-user-profile")()}Math;var p=g._export_sfc(d,[["render",function(e,i,t,o,n,s){return{a:g.f(n.servicesList,((e,i,t)=>({a:e.logo,b:g.t(e.text),c:i,d:g.o((i=>e.path?s.navigateTo(e.path):s.login_before(e.id,!1)),i)}))),b:g.sr("userProfile","12b99efe-0"),c:g.o(s.doUserProfileNext)}}]]);wx.createComponent(p);
