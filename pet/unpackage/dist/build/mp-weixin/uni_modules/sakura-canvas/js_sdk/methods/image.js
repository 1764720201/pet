"use strict";var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,i=(t,r,a)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[r]=a,n=(e,t)=>{for(var r in t||(t={}))s.call(t,r)&&i(e,r,t[r]);if(a)for(var r of a(t))o.call(t,r)&&i(e,r,t[r]);return e},d=(e,a)=>t(e,r(a)),c=require("../../../../common/vendor.js"),w=require("../utils/util.js");const m=(e,t,r,a,s,o,i)=>"aspectFit"===i?function(e,t,r,a,s,o){let i=t/e,n=s,d=i*n;i>=1&&(i=e/t,d=o,n=i*d);return{sw:n,sh:d,sx:r+(s-n)/2,sy:a+(o-d)/2,dw:e,dh:t,dx:0,dy:0}}(e,t,r,a,s,o):"aspectFill"===i?l(e,t,r,a,s,o):"widthFix"===i?function(e,t,r,a,s,o){return{sw:s,sh:s*(t/e),sx:r,sy:a,dw:e,dh:t,dx:0,dy:0}}(e,t,r,a,s):"heightFix"===i?function(e,t,r,a,s,o){return{sw:o*(e/t),sh:o,sx:r,sy:a,dw:e,dh:t,dx:0,dy:0}}(e,t,r,a,0,o):"default"===i?{dw:s,dh:o,dx:r,dy:a}:l(e,t,r,a,s,o);function l(e,t,r,a,s,o){let i=t/e,n=s,d=i*n,c=0,w=(t-o*(t/d))/2;return i<1&&(i=e/t,d=o,n=i*d,w=0,c=(e-s*(e/n))/2),{sw:n,sh:d,sx:r,sy:a,dw:e,dh:t,dx:c,dy:w}}const h=e=>new Promise((t=>{c.index.getImageInfo({src:e,success:e=>{t(n({success:!0},e))},fail:e=>{t({success:!1,msg:e})}})}));function g(e){return new Promise((async t=>{if((e=await w.base64ToPathFn(e)).includes("http")){const r=await w.downloadFile(e);if(!r.success)return t({success:!1,msg:`图片路径为:${e}的文件下载失败`});e=r.data.tempFilePath}return t({success:!0,src:e})}))}exports.DrawImage=class{constructor(e){const{Context:t,commonUtilMethods:r,commonDrawMethods:a}=e;this.Context=t,this.commonUtilMethods=r,this.commonDrawMethods=a}getDrawParams(e={},t=!0){const r=this.commonUtilMethods.getGlobalDataDrawParams(e),{src:a="",mode:s="aspectFill",triangle:o={},isCompressImage:i=!1,quality:c=100,drawSrc:w=!1,drawModeImage:m=!1,drawImageInfo:l=!1}=e,h=d(n({},r),{src:a,mode:s,drawType:e.drawType||"default",triangle:o,isCompressImage:i,quality:c,drawSrc:w,drawModeImage:m,drawImageInfo:l,drawImage:!0});return t?this.commonUtilMethods.conversionUnit(h):h}draw(e={},t=!0){const{Context:r,commonUtilMethods:i,commonDrawMethods:c}=this,{canvasWidth:w,is2d:m}=i;let l=this.getDrawParams(e,t),{w:u,src:f,windowAlign:p,drawModeImage:y,offsetRight:x,x:I}=l,b=((e,t)=>{var r={};for(var i in e)s.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&a)for(var i of a(e))t.indexOf(i)<0&&o.call(e,i)&&(r[i]=e[i]);return r})(l,["w","src","windowAlign","drawModeImage","offsetRight","x"]);return new Promise((async e=>{try{if(!/\S/.test(f))return e({success:!1,message:"图片路径为空"});if(!m){let t=await g(f);if(!t.success)return e(t);f=t.src}"none"!==p&&(I=c.computedCenterX(w,u,p,x));let t=y;if(!t&&(t=await h(f),!t.success))return e(t);const r=this.getImage(f),a=d(n({},b),{x:I,imageInfo:t,img:r,w:u,src:f,windowAlign:p,drawModeImage:y,offsetRight:x});if(!m)return e(await this.drawImageByType(a));r.onload=async()=>e(await this.drawImageByType(a))}catch(t){return e({success:!1,msg:"绘制图片出错"+t})}}))}drawImageByType(e){let{imageInfo:t,r:r,x:a,y:s,w:o,h:i,rotate:n,borderWidth:d,borderColor:c,color:w,alpha:l,borderType:h,triangle:g,mode:u,drawType:f,img:p,shadow:y,drawSrc:x,drawModeImage:I}=e;const{Context:b,commonDrawMethods:P,commonUtilMethods:M}=this,{unit:C,pxToRpx:T}=M;return new Promise((async e=>{0===i&&(i=o);let x=I;x||(x=m(Number(t.width),Number(t.height),a,s,o,i,u));const{dx:M,dy:v,dw:O,dh:D,sw:F,sh:j,sx:U,sy:A}=x;b.save(),b.beginPath(),"triangle"!==f&&P.setRotate(a,s,o,i,n);const R=async()=>{b.clip(),P.setAlpha(l),await this.drawImageContent(u,f,p,M,v,O,D,U,A,F,j),b.restore()};if("default"==f)P.setAlpha(l),await this.drawImageContent(u,f,p,M,v,O,D,U,A,F,j,a,s,o,i),b.clip(),b.restore();else if("arc"===f)P.drawParams.drawArc.draw({x:a,y:s,r:o/2,borderWidth:d,borderColor:c,color:w,drawImage:!0,shadow:y},!1),R();else if("rect"===f)"widthFix"===u?i=j:"heightFix"===u&&(o=F),P.drawParams.drawRect.draw({x:a,y:s,w:o,h:i,alpha:l,borderWidth:d,borderColor:c,borderType:h,r:r,color:w,drawImage:!0,shadow:y},!1),R();else if("triangle"===f){let e=g.type||"isosceles",t=g.coordinate||[],r=g.direction||"top";"custom"!==e&&P.setTriangleRotate(a,s,o,i,n,e),P.drawParams.drawTriangle.draw({x:a,y:s,w:o,h:i,alpha:l,borderWidth:d,borderColor:c,color:w,coordinate:t,direction:r,drawType:e,drawImage:!0},!1),R()}return P.setAlpha(1),e({success:!0,w:"rpx"===C?T(o):o,h:"rpx"===C?T(i):i})}))}drawImageContent(e,t,r,a,s,o,i,n,d,c,w,m,l,h,g){const{Context:u}=this;return new Promise((async f=>{"default"===t?await u.drawImage(r,m,l,h,g):"default"!==e?await u.drawImage(r,a,s,o,i,n,d,c,w):await u.drawImage(r,a,s,o,i),f(!0)}))}getImage(e){const{commonUtilMethods:t}=this,{is2d:r,canvas:a}=t;if(r){const t=a.createImage();return t.src=e,t}return e}},exports.getImageInfo=h,exports.getImageSrc=g,exports.getModeImage=m;
