"use strict";var t=Object.defineProperty,e=Object.defineProperties,n=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,s=(e,n,o)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[n]=o,r=(t,e)=>{for(var n in e||(e={}))i.call(e,n)&&s(t,n,e[n]);if(o)for(var n of o(e))l.call(e,n)&&s(t,n,e[n]);return t},h=(t,o)=>e(t,n(o)),a=require("../../../../common/vendor.js"),x=require("../utils/util.js");exports.DrawText=class{constructor(t){const{Context:e,commonUtilMethods:n,commonDrawMethods:o}=t;this.Context=e,this.commonUtilMethods=n,this.commonDrawMethods=o}getDrawParams(t={},e=!0){const n=this.commonUtilMethods.getGlobalDataDrawParams(t),{text:o="",textIndent:i=0,lastWidth:l=0,font:s={},textAlign:a="none",baseline:x="top",line:c={},highlightText:g=[],textRect:d={show:!1,isFill:!0,lineWidth:1}}=t,f=h(r({},n),{text:String(o)||"",textIndent:i,lastWidth:l,font:e?this.commonUtilMethods.conversionUnit(this.getFontStyle(s)):this.getFontStyle(s,e),textAlign:a,baseline:x,line:this.getTextLine(c,e),highlightText:g,textRect:d});return e?this.commonUtilMethods.conversionUnit(f):f}draw(t={},e=!0){var n;const{Context:s,commonUtilMethods:h,commonDrawMethods:x}=this,{canvasWidth:c,is2d:g}=h;let{x:d,y:f,w:y,h:m,text:u,textIndent:w,lastWidth:p,font:b,color:S,alpha:v,isFill:T,line:j,windowAlign:C,textAlign:U,baseline:M,highlightText:O,textRect:P,offsetRight:F}=this.getDrawParams(t,e);s.save(),s.beginPath(),x.setAlpha(v),s.font=b.style,g?s.textBaseline=M:s.setTextBaseline(M),"string"!=typeof u&&(u+="");let z=t.textArr;if(z||(z=x.computedFontTextLineHeight(d,f,y,u,w,p,b,j,U,C,S,F)),0!=O.length&&(z=this.getHighlightText(z,O,S,b)),P.show){const e=h.conversionUnit(P),{vorizontal:s,vertical:g}=e,d=((t,e)=>{var n={};for(var s in t)i.call(t,s)&&e.indexOf(s)<0&&(n[s]=t[s]);if(null!=t&&o)for(var s of o(t))e.indexOf(s)<0&&l.call(t,s)&&(n[s]=t[s]);return n})(e,["vorizontal","vertical"]),f=z[0];let m=y===c?null!=(n=h.conversionUnit(t).tw)?n:f.w:y,u=f.x-s,w=f.y-g,p=z[z.length-1].y+b.fontSize-f.y;p+=2*g,"android"===a.index.getSystemInfoSync().platform&&(w+=b.fontSize/3,p-=b.fontSize/3),m+=2*s,x.drawParams.drawRect.draw(r({x:u,y:w,w:m,h:p},d),!1)}s.font=b.style,z.forEach((t=>{let{text:e,x:n,y:o,tx:i,ty:l,tw:r,fontColor:h}=t;T?(x.setFillStyle(h),s.fillText(e,n,o)):(x.setStrokeStyle(h),s.strokeText(e,n,o)),"none"!==j.lineStyle&&(T?x.setFillStyle(S):x.setStrokeStyle(S),x.drawParams.drawLine.draw({x:i,y:l,w:r,color:S,lineType:j.lineType,lineWidth:j.lineWidth},!1))})),s.restore(),s.font=this.getFontStyle().style,x.setAlpha(1)}getFontStyle(t={},e=!0){const{size:n,family:o,style:i,variant:l,weight:s}=r(r({},this.commonUtilMethods.fontStyle),t);return{fontSize:n,fontSizeBefore:n,fontFamily:o,fontStyle:i,fontVariant:l,fontWeight:s,style:`${i} ${l} ${s} ${e?this.commonUtilMethods.getConvertedValue(n):n}px ${o}`}}getTextLine(t={},e=!0){const{num:n=-1,height:o=0,style:i="none",type:l="solid",width:s=1}=t;return{lineNum:n,lineHeight:e?this.commonUtilMethods.getConvertedValue(o):o,lineStyle:i,lineType:l,lineWidth:s}}getHighlightText(t,e,n,o){const i=[],l=[],{fontSize:s}=o;e.map((t=>{const{text:e,color:n}=t;return[...e].map((t=>({text:t,color:n})))})).forEach((t=>{const e=t.map((t=>t.text)),n=t.map((t=>t.color));i.push(...e),l.push(...n)}));const a=[];return t.forEach(((t,e)=>{const{x:o,y:c,w:g,text:d,tx:f,ty:y,tw:m}=t,u=[...d];let w=[];for(let r in u){const t=u[r],e=i.findIndex((e=>t==e));if(-1!==e&&-1!==e){const i={text:t,index:r,x:o+x.countTextLength(this.Context,u.join("").substring(0,r),s),fontColor:l[e],y:c,tx:f,ty:y,tw:m,w:g},h=0==w.length?0:Number(w[w.length-1].index),d=Number(i.index);if(d-h>1){const t={text:u.join("").substring(w[h]?h+1:h,d),index:0===h?0:h+1,x:o+x.countTextLength(this.Context,u.join("").substring(0,w[h]?h+1:h),s),fontColor:n,y:c,tx:f,ty:y,tw:m,w:g};a.push(t)}w.push(i),a.push(i)}}if(0===w.length)a.push(h(r({},t),{tx:f,ty:y,tw:m,w:g,fontColor:n}));else{const t=Number(w[w.length-1].index)+1,e=u.length;if(t===e)return;const i={text:u.join("").substring(t,e),index:t,x:o+x.countTextLength(this.Context,u.join("").substring(0,t),s),fontColor:n,y:c,tx:f,ty:y,tw:m,w:g};a.push(i)}})),a}};
